{% from "admin/_macros.html" import render_field_with_errors, render_field %}
{% extends 'admin/layout.html' %}

{% block content %}
<header>
    <h1>Post</h1>
    <div>
        {% if post %}
            <div><a href="{{ url_for('taozi.post', slug=post.slug, issue=post.issue.slug) }}">
                {% if post.published %}View{% else %}Preview{% endif %}
            </a></div>
        {% endif %}
    </div>
</header>
<form method="POST" action="{{ action }}">
  {% include "_messages.html" %}
  {{ form.hidden_tag() }}
  {{ render_field_with_errors(form.title) }}
  {{ render_field_with_errors(form.subtitle) }}
  {{ render_field_with_errors(form.slug, extras={'regenerate-slug': 'ðŸ”„'}) }}
  {{ render_field_with_errors(form.desc) }}
  <div class="textarea">
      {{ render_field_with_errors(form.body) }}
  </div>
  {{ render_field_with_errors(form.redirect) }}
  <div class="column-2">
      <div>
        {{ render_field_with_errors(form.authors) }}
      </div>
      <div>
        {{ render_field_with_errors(form.issue) }}
        {{ render_field_with_errors(form.image) }}
      </div>
  </div>
  {{ render_field_with_errors(form.tags) }}
  <div class="column-2 published-fields">
      {{ render_field_with_errors(form.published_at) }}
      <div>
          {{ render_field_with_errors(form.published) }}
          {{ render_field_with_errors(form.visible) }}
      </div>
    </div>
  <div class="actions">
    <input type="submit" value="Save">
    <div id="js-delete-post">Delete</div>
  </div>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.getElementById('js-delete-post').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this post?')) {
            fetch('', {
                method: 'DELETE',
                headers: {'content-type': 'application/json'}
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    alert('Successfully deleted.');
                }
            });
        }
    });
    const conf = {
        enableTime: true,
        dateFormat: "Y-m-d H:i"
    };
    flatpickr('#published_at', conf);

    document.getElementById('published').addEventListener('change', (ev) => {
        let pub_at = document.getElementById('published_at');
        if (ev.target.checked && pub_at.value == '') {
            let d = new Date();
            let month = (d.getMonth() + 1).toString().padStart(2, '0');
            let day = d.getDate().toString().padStart(2, '0');
            let hours = d.getHours().toString().padStart(2, '0');
            let mins = d.getMinutes().toString().padStart(2, '0');
            pub_at.value = `${d.getFullYear()}-${month}-${day} ${hours}:${mins}`;
        }
    });

    // https://gist.github.com/codeguy/6684588#gistcomment-3243980
    function slugify(text) {
      return text
        .toString()                     // Cast to string
        .toLowerCase()                  // Convert the string to lowercase letters
        .normalize('NFD')               // The normalize() method returns the Unicode Normalization Form of a given string.
        .trim()                         // Remove whitespace from both sides of a string
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
        .replace(/\-\-+/g, '-');        // Replace multiple - with single -
    }

    const title = document.getElementById('title');
    const slug = document.getElementById('slug');
    function generateSlug() {
        if (title.value.length > 0) {
            slug.value = slugify(title.value);
        };
    }
    document.getElementById('title').addEventListener('change', (ev) => {
        if (slug.value == '') generateSlug();
    });
    document.getElementById('regenerate-slug').addEventListener('click', generateSlug);
</script>
{% endblock %}
